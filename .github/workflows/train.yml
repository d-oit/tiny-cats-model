# .github/workflows/train.yml
# CI pipeline: lint, test, and optional training proof
# Triggers on push and pull_request to main
# ADR-016: Modern Python Code Quality (Ruff only)

name: Train

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_training:
        description: "Skip Modal training (for testing CI only)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: read

# 2026 Best Practice: Smart concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  lint:
    name: Lint (Ruff)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements*.txt

      - name: Install lint dependencies
        run: |
          pip install --upgrade pip
          pip install ruff

      - name: Run ruff format check
        run: ruff format --check .

      - name: Run ruff lint
        run: ruff check .

  test:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: requirements*.txt

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

  model-import-check:
    name: Model Import Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: requirements*.txt

      - name: Install dependencies
        run: |
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements.txt

      - name: Verify model builds
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from model import cats_model, count_parameters
          m = cats_model(num_classes=2, backbone='resnet18', pretrained=False)
          params = count_parameters(m)
          print(f'Model OK: {params:,} trainable parameters')
          assert params > 0, 'Model has no trainable parameters'
          "

      - name: Verify dataset module imports
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from dataset import build_transforms, get_class_names
          t = build_transforms(train=True)
          print(f'Transforms OK: {t}')
          "

  train-classifier:
    name: Train Classifier (Modal)
    needs: [lint, test, model-import-check]
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_training
    runs-on: ubuntu-latest
    environment:
      name: modal-training
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Modal
        run: pip install modal

      - name: Run training
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: modal run src/train.py data/cats

      - name: Download ONNX from Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          pip install modal
          modal volume get cats-model-outputs /outputs/cats_classifier.onnx ./cats_classifier.onnx

      - name: Upload to Hugging Face Hub
        if: vars.HF_TOKEN != ''
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub
          python -c "
          from huggingface_hub import HfApi
          api = HfApi()
          api.upload_file(
              path_or_fileobj='cats_classifier.onnx',
              path_in_repo='cats_classifier.onnx',
              repo_id='d4oit/tiny-cats-model',
              repo_type='model',
              commit_message='Upload classifier from GitHub Actions'
          )
          print('Classifier uploaded to HF Hub')
          "

  train-dit:
    name: Train DiT (Modal)
    needs: [lint, test, model-import-check]
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_training
    runs-on: ubuntu-latest
    environment:
      name: modal-training
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Modal
        run: pip install modal

      - name: Run DiT training
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: modal run src/train_dit.py data/cats

      - name: Download ONNX from Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          pip install modal
          modal volume get dit-outputs /outputs/cats_dit.onnx ./cats_dit.onnx

      - name: Upload to Hugging Face Hub
        if: vars.HF_TOKEN != ''
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub
          python -c "
          from huggingface_hub import HfApi
          api = HfApi()
          api.upload_file(
              path_or_fileobj='cats_dit.onnx',
              path_in_repo='cats_dit.onnx',
              repo_id='d4oit/tiny-cats-model',
              repo_type='model',
              commit_message='Upload DiT from GitHub Actions'
          )
          print('DiT uploaded to HF Hub')
          "
