# .github/workflows/train.yml
# CI pipeline: lint, test, and optional training proof
# Triggers on push and pull_request to main
# ADR-016: Modern Python Code Quality (Ruff only)

name: Train

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_training:
        description: "Skip Modal training (for testing CI only)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: read

# 2026 Best Practice: Smart concurrency
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  lint:
    name: Lint (Ruff)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements*.txt

      - name: Install lint dependencies
        run: |
          pip install --upgrade pip
          pip install ruff

      - name: Run ruff format check
        run: ruff format --check .

      - name: Run ruff lint
        run: ruff check .

  test:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: requirements*.txt

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

  model-import-check:
    name: Model Import Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip
          cache-dependency-path: requirements*.txt

      - name: Install dependencies
        run: |
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements.txt

      - name: Verify model builds
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from model import cats_model, count_parameters
          m = cats_model(num_classes=2, backbone='resnet18', pretrained=False)
          params = count_parameters(m)
          print(f'Model OK: {params:,} trainable parameters')
          assert params > 0, 'Model has no trainable parameters'
          "

      - name: Verify dataset module imports
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          from dataset import build_transforms, get_class_names
          t = build_transforms(train=True)
          print(f'Transforms OK: {t}')
          "

  train-classifier:
    name: Train Classifier (Modal)
    needs: [lint, test, model-import-check]
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_training
    runs-on: ubuntu-latest
    environment:
      name: modal-training
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Modal
        run: pip install modal

      - name: Run training
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: modal run src/train.py data/cats

      - name: Download ONNX from Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          pip install modal
          modal volume get cats-model-outputs /outputs/cats_classifier.onnx ./cats_classifier.onnx
          modal volume get cats-model-outputs /outputs/best_cats_model.pt ./best_cats_model.pt || true

      - name: Upload to Hugging Face Hub
        if: env.HF_TOKEN != ''
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub safetensors pillow

          # Run evaluation if generator checkpoint exists
          if [ -f "tinydit_final.pt" ]; then
            echo "Running evaluation..."
            python src/evaluate_full.py --checkpoint tinydit_final.pt \
              --generate-samples --num-samples 16 --all-breeds \
              --output-dir samples/evaluation \
              --report-path evaluation_report.json || true
          fi

          # Run benchmarks if models exist
          if [ -f "tinydit_final.pt" ]; then
            echo "Running benchmarks..."
            python src/benchmark_inference.py --model tinydit_final.pt \
              --device cpu --num-warmup 5 --num-runs 20 \
              --benchmark-throughput --batch-sizes 1,4,8 \
              --report-path benchmark_report.json || true
          fi

          # Use comprehensive upload utility
          python src/upload_to_huggingface.py \
            --classifier best_cats_model.pt \
            --generator tinydit_final.pt \
            --onnx-classifier cats_classifier.onnx \
            --onnx-generator generator.onnx \
            --evaluation-report evaluation_report.json \
            --benchmark-report benchmark_report.json \
            --samples-dir samples/evaluation \
            --repo-id d4oit/tiny-cats-model \
            --commit-message "Upload full model package from GitHub Actions" || \
          python -c "
          from huggingface_hub import HfApi
          api = HfApi()
          
          # Fallback: upload individual files
          import os
          if os.path.exists('cats_classifier.onnx'):
              api.upload_file('cats_classifier.onnx', 'classifier/model.onnx', 'd4oit/tiny-cats-model')
          if os.path.exists('cats_quantized.onnx'):
              api.upload_file('cats_quantized.onnx', 'classifier/model_quantized.onnx', 'd4oit/tiny-cats-model')
          if os.path.exists('best_cats_model.pt'):
              api.upload_file('best_cats_model.pt', 'classifier/model.pt', 'd4oit/tiny-cats-model')
          if os.path.exists('generator.onnx'):
              api.upload_file('generator.onnx', 'generator/model.onnx', 'd4oit/tiny-cats-model')
          if os.path.exists('generator_quantized.onnx'):
              api.upload_file('generator_quantized.onnx', 'generator/model_quantized.onnx', 'd4oit/tiny-cats-model')
          if os.path.exists('tinydit_final.pt'):
              api.upload_file('tinydit_final.pt', 'generator/model.pt', 'd4oit/tiny-cats-model')
          print('Files uploaded successfully')
          "

  train-dit:
    name: Train DiT (Modal)
    needs: [lint, test, model-import-check]
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_training
    runs-on: ubuntu-latest
    environment:
      name: modal-training
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Modal
        run: pip install modal

      - name: Run DiT training
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: modal run src/train_dit.py data/cats

      - name: Download ONNX from Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          pip install modal
          modal volume get dit-outputs /outputs/cats_dit.onnx ./cats_dit.onnx
          modal volume get dit-outputs /outputs/generator.onnx ./generator.onnx || true
          modal volume get dit-outputs /outputs/tinydit_final.pt ./tinydit_final.pt || true

      - name: Upload to Hugging Face Hub
        if: env.HF_TOKEN != ''
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub safetensors pillow

          # Run evaluation if generator checkpoint exists
          if [ -f "tinydit_final.pt" ]; then
            echo "Running evaluation..."
            python src/evaluate_full.py --checkpoint tinydit_final.pt \
              --generate-samples --num-samples 16 --all-breeds \
              --output-dir samples/evaluation \
              --report-path evaluation_report.json || true
          fi

          # Run benchmarks if models exist
          if [ -f "tinydit_final.pt" ] || [ -f "generator.onnx" ]; then
            echo "Running benchmarks..."
            python src/benchmark_inference.py --model tinydit_final.pt \
              --device cpu --num-warmup 5 --num-runs 20 \
              --benchmark-throughput --batch-sizes 1,4,8 \
              --report-path benchmark_report.json || true
          fi

          # Use comprehensive upload utility
          python src/upload_to_huggingface.py \
            --generator tinydit_final.pt \
            --onnx-generator generator.onnx \
            --evaluation-report evaluation_report.json \
            --benchmark-report benchmark_report.json \
            --samples-dir samples/evaluation \
            --repo-id d4oit/tiny-cats-model \
            --commit-message "Upload DiT model package from GitHub Actions" || \
          python -c "
          from huggingface_hub import HfApi
          api = HfApi()
          
          # Fallback: upload individual files
          import os
          if os.path.exists('generator.onnx'):
              api.upload_file('generator.onnx', 'generator/model.onnx', 'd4oit/tiny-cats-model')
          if os.path.exists('generator_quantized.onnx'):
              api.upload_file('generator_quantized.onnx', 'generator/model_quantized.onnx', 'd4oit/tiny-cats-model')
          if os.path.exists('tinydit_final.pt'):
              api.upload_file('tinydit_final.pt', 'generator/model.pt', 'd4oit/tiny-cats-model')
          print('Files uploaded successfully')
          "
